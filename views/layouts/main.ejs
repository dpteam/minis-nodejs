<div class="vk-content-box">
    <h2><i class="fas fa-envelope"></i> Сообщения</h2>
    
    <div class="vk-messages-container">
        <!-- Conversations List -->
        <div class="vk-conversations-list">
            <div class="vk-conversations-header">
                <h3><i class="fas fa-comments"></i> Диалоги</h3>
                <a href="/messages/new" class="vk-btn vk-btn-small">
                    <i class="fas fa-plus"></i> Новое сообщение
                </a>
            </div>
            
            <div class="vk-conversations-search">
                <input type="text" class="vk-form-control" placeholder="Поиск диалогов..." id="searchConversations">
            </div>
            
            <div class="vk-conversations">
                <% if (conversations.length > 0) { %>
                    <% conversations.forEach(conversation => { %>
                    <div class="vk-conversation <%= conversation.id === activeConversationId ? 'vk-active' : '' %>" onclick="loadConversation(<%= conversation.id %>)">
                        <div class="vk-conversation-avatar">
                            <% if (conversation.otherUser.avatar) { %>
                                <img src="<%= conversation.otherUser.avatar %>" alt="<%= conversation.otherUser.firstName %> <%= conversation.otherUser.lastName %>" style="width: 40px; height: 40px; border-radius: 2px; object-fit: cover;">
                            <% } else { %>
                                <i class="fas fa-user"></i>
                            <% } %>
                            <% if (conversation.unreadCount > 0) { %>
                                <span class="vk-unread-count"><%= conversation.unreadCount %></span>
                            <% } %>
                        </div>
                        <div class="vk-conversation-info">
                            <div class="vk-conversation-name"><%= conversation.otherUser.firstName %> <%= conversation.otherUser.lastName %></div>
                            <div class="vk-conversation-preview"><%= conversation.lastMessage.content.substring(0, 50) %>...</div>
                            <div class="vk-conversation-time"><%= conversation.lastMessage.createdAt %></div>
                        </div>
                    </div>
                    <% }); %>
                <% } else { %>
                    <div class="vk-empty-conversations">
                        <i class="fas fa-comments"></i>
                        <p>Нет диалогов</p>
                        <a href="/messages/new" class="vk-btn">Начать новый диалог</a>
                    </div>
                <% } %>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="vk-messages-area">
            <% if (activeConversation) { %>
                <div class="vk-messages-header">
                    <div class="vk-messages-user-info">
                        <div class="vk-messages-avatar">
                            <% if (activeConversation.otherUser.avatar) { %>
                                <img src="<%= activeConversation.otherUser.avatar %>" alt="<%= activeConversation.otherUser.firstName %> <%= activeConversation.otherUser.lastName %>" style="width: 32px; height: 32px; border-radius: 2px; object-fit: cover;">
                            <% } else { %>
                                <i class="fas fa-user"></i>
                            <% } %>
                        </div>
                        <div>
                            <div class="vk-messages-user-name"><%= activeConversation.otherUser.firstName %> <%= activeConversation.otherUser.lastName %></div>
                            <div class="vk-messages-user-status <%= activeConversation.otherUser.isOnline ? 'vk-online' : 'vk-offline' %>">
                                <i class="fas fa-circle"></i> <%= activeConversation.otherUser.isOnline ? 'Онлайн' : 'Офлайн' %>
                            </div>
                        </div>
                    </div>
                    <div class="vk-messages-actions">
                        <a href="/profile/<%= activeConversation.otherUser.id %>" class="vk-btn vk-btn-small">
                            <i class="fas fa-user"></i>
                        </a>
                        <button class="vk-btn vk-btn-small vk-btn-secondary" onclick="clearConversation(<%= activeConversation.id %>)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="vk-messages-list" id="messagesList">
                    <% activeConversation.messages.forEach(message => { %>
                    <div class="vk-message <%= message.senderId === user.id ? 'vk-message-sent' : 'vk-message-received' %>">
                        <div class="vk-message-avatar">
                            <% if (message.sender.avatar) { %>
                                <img src="<%= message.sender.avatar %>" alt="<%= message.sender.firstName %> <%= message.sender.lastName %>" style="width: 24px; height: 24px; border-radius: 2px; object-fit: cover;">
                            <% } else { %>
                                <i class="fas fa-user"></i>
                            <% } %>
                        </div>
                        <div class="vk-message-content">
                            <div class="vk-message-text"><%= message.content %></div>
                            <div class="vk-message-time"><%= message.createdAt %></div>
                        </div>
                    </div>
                    <% }); %>
                </div>
                
                <div class="vk-messages-input">
                    <form id="messageForm" onsubmit="sendMessage(event, <%= activeConversation.id %>)">
                        <div class="vk-form-group">
                            <textarea id="messageInput" class="vk-form-control" placeholder="Написать сообщение..." rows="2" required></textarea>
                        </div>
                        <button type="submit" class="vk-btn">
                            <i class="fas fa-paper-plane"></i> Отправить
                        </button>
                    </form>
                </div>
            <% } else { %>
                <div class="vk-no-conversation">
                    <i class="fas fa-comments"></i>
                    <p>Выберите диалог или начните новый</p>
                    <a href="/messages/new" class="vk-btn">Новое сообщение</a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
let currentConversationId = <%= activeConversationId || 'null' %>;

function loadConversation(conversationId) {
    window.location.href = '/messages?conversation=' + conversationId;
}

function sendMessage(event, conversationId) {
    event.preventDefault();
    
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content) return;
    
    fetch(`/messages/send/${conversationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            // Reload to show new message
            location.reload();
        }
    });
}

function clearConversation(conversationId) {
    if (confirm('Вы уверены, что хотите очистить этот диалог?')) {
        fetch(`/messages/clear/${conversationId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

// Auto-scroll to bottom of messages
function scrollToBottom() {
    const messagesList = document.getElementById('messagesList');
    if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
    }
}

// Search conversations
document.getElementById('searchConversations')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const conversations = document.querySelectorAll('.vk-conversation');
    
    conversations.forEach(conversation => {
        const name = conversation.querySelector('.vk-conversation-name').textContent.toLowerCase();
        const preview = conversation.querySelector('.vk-conversation-preview').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || preview.includes(searchTerm)) {
            conversation.style.display = 'flex';
        } else {
            conversation.style.display = 'none';
        }
    });
});

// Scroll to bottom when page loads
document.addEventListener('DOMContentLoaded', scrollToBottom);
</script>