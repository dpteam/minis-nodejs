<div class="vk-content-box">
    <h2><i class="fas fa-newspaper"></i> Новости</h2>
    
    <!-- Post Form -->
    <% if (user) { %>
    <form action="/posts" method="POST" class="vk-post-form">
        <div class="vk-form-group">
            <textarea name="content" class="vk-form-control" placeholder="Что у вас нового?" required><%= typeof postContent !== 'undefined' ? postContent : '' %></textarea>
        </div>
        <button type="submit" class="vk-btn">
            <i class="fas fa-paper-plane"></i> Опубликовать
        </button>
    </form>
    <hr style="margin: 15px 0; border: none; border-top: 1px solid #E8EBEE;">
    <% } %>

    <!-- Posts -->
    <div class="vk-posts">
        <% posts.forEach(post => { %>
        <div class="vk-post">
            <div class="vk-post-header">
                <div class="vk-post-avatar">
                    <% if (post.author.avatar) { %>
                        <img src="<%= post.author.avatar %>" alt="<%= post.author.firstName %> <%= post.author.lastName %>" style="width: 32px; height: 32px; border-radius: 2px; object-fit: cover;">
                    <% } else { %>
                        <i class="fas fa-user"></i>
                    <% } %>
                </div>
                <div>
                    <a href="/profile/<%= post.author.id %>" class="vk-post-author"><%= post.author.firstName %> <%= post.author.lastName %></a>
                    <span class="vk-post-time"><%= post.createdAt %></span>
                </div>
            </div>
            <div class="vk-post-content">
                <%= post.content %>
            </div>
            <div class="vk-post-actions">
                <a href="#" onclick="likePost(<%= post.id %>)">
                    <i class="fas fa-thumbs-up"></i> Мне нравится <%= post.likes && post.likes.length > 0 ? '(' + post.likes.length + ')' : '' %>
                </a>
                <a href="#" onclick="showComments(<%= post.id %>)">
                    <i class="fas fa-comment"></i> Комментарии <%= post.comments && post.comments.length > 0 ? '(' + post.comments.length + ')' : '' %>
                </a>
                <a href="#" onclick="sharePost(<%= post.id %>)">
                    <i class="fas fa-share"></i> Поделиться
                </a>
                <% if (user && user.id === post.author.id) { %>
                <a href="#" onclick="deletePost(<%= post.id %>)">
                    <i class="fas fa-trash"></i> Удалить
                </a>
                <% } %>
            </div>
            
            <!-- Comments Section -->
            <div id="comments-<%= post.id %>" class="vk-comments" style="display: none;">
                <% if (post.comments && post.comments.length > 0) { %>
                    <% post.comments.forEach(comment => { %>
                    <div class="vk-comment">
                        <div class="vk-comment-header">
                            <div class="vk-comment-avatar">
                                <% if (comment.author.avatar) { %>
                                    <img src="<%= comment.author.avatar %>" alt="<%= comment.author.firstName %> <%= comment.author.lastName %>" style="width: 24px; height: 24px; border-radius: 2px; object-fit: cover;">
                                <% } else { %>
                                    <i class="fas fa-user"></i>
                                <% } %>
                            </div>
                            <div>
                                <a href="/profile/<%= comment.author.id %>" class="vk-comment-author"><%= comment.author.firstName %> <%= comment.author.lastName %></a>
                                <span class="vk-comment-time"><%= comment.createdAt %></span>
                            </div>
                        </div>
                        <div class="vk-comment-content">
                            <%= comment.content %>
                        </div>
                        <div class="vk-comment-actions">
                            <% if (user && user.id === comment.author.id) { %>
                            <a href="#" onclick="deleteComment(<%= comment.id %>)">
                                <i class="fas fa-trash"></i> Удалить
                            </a>
                            <% } %>
                        </div>
                    </div>
                    <% }); %>
                <% } %>
                
                <!-- Add Comment Form -->
                <% if (user) { %>
                <form action="/posts/<%= post.id %>/comments" method="POST" class="vk-comment-form">
                    <div class="vk-form-group">
                        <input type="text" name="content" class="vk-form-control" placeholder="Написать комментарий..." required>
                    </div>
                    <button type="submit" class="vk-btn vk-btn-small">
                        <i class="fas fa-paper-plane"></i> Отправить
                    </button>
                </form>
                <% } %>
            </div>
        </div>
        <% }); %>
        
        <% if (posts.length === 0) { %>
        <div class="vk-empty-state">
            <i class="fas fa-newspaper"></i>
            <p>Нет записей</p>
        </div>
        <% } %>
    </div>
</div>

<script>
function likePost(postId) {
    fetch(`/posts/${postId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function showComments(postId) {
    const commentsDiv = document.getElementById(`comments-${postId}`);
    commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
}

function sharePost(postId) {
    if (navigator.share) {
        navigator.share({
            title: 'Поделиться записью',
            url: window.location.origin + '/posts/' + postId
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.origin + '/posts/' + postId);
        alert('Ссылка скопирована в буфер обмена');
    }
}

function deletePost(postId) {
    if (confirm('Вы уверены, что хотите удалить эту запись?')) {
        fetch(`/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function deleteComment(commentId) {
    if (confirm('Вы уверены, что хотите удалить этот комментарий?')) {
        fetch(`/comments/${commentId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}
</script>